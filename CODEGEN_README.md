# ToyC编译器代码生成功能

## 项目概述

我已经成功为ToyC编译器添加了RISC-V 32位汇编代码生成功能。新增的模块包括：

### 1. RISC-V指令定义模块 (`riscv.ml`)

定义了RISC-V 32位指令集的抽象表示：

- **寄存器类型**：定义了所有RISC-V 32位寄存器（x0-x31）
- **指令类型**：包括算术、逻辑、比较、加载/存储、分支、跳转等指令
- **汇编项类型**：支持指令、标签、注释和汇编指令
- **输出功能**：提供将指令转换为汇编字符串和文件输出的功能

### 2. 代码生成模块 (`codegen.ml`)

实现了从AST到RISC-V汇编代码的翻译：

#### 表达式代码生成

- **整数常量**：使用 `li` 指令加载立即数
- **变量引用**：从栈中加载变量值
- **一元运算**：支持否定（`-`）和逻辑非（`!`）
- **二元运算**：支持所有算术、比较和逻辑运算
- **函数调用**：按照RISC-V调用约定传递参数和获取返回值

#### 控制流语句代码生成

- **条件语句（if-else）**：使用条件分支指令和标签实现
- **循环（while）**：生成循环标签和条件跳转
- **break/continue**：跳转到相应的循环标签

#### 函数代码生成

- **函数序言**：保存调用者状态，设置栈帧
- **参数处理**：将寄存器参数保存到栈中
- **函数体**：递归生成所有语句的代码
- **函数尾声**：恢复调用者状态，返回

### 3. 关键技术特性

#### 寄存器分配

- 使用临时寄存器（t0-t6）进行表达式计算
- 按照RISC-V ABI使用参数寄存器（a0-a7）
- 使用栈指针（sp）和帧指针（s0）管理栈帧

#### 栈管理

- 局部变量分配在栈上
- 函数参数从寄存器保存到栈中
- 支持作用域嵌套的变量管理

#### 标签管理

- 自动生成唯一的标签名
- 支持嵌套的控制流结构
- 正确处理break/continue的跳转目标

### 4. 代码示例

例如，对于以下ToyC代码：

```c
int main() {
    int x = 5;
    int y = 10;
    int z = x + y;
    return z;
}
```

生成的RISC-V汇编代码会包括：

```assembly
.text
.globl main
main:
    # 函数序言
    addi x2, x2, -4     # 分配返回地址空间
    sw x1, 0(x2)        # 保存返回地址
    addi x2, x2, -4     # 分配帧指针空间
    sw x8, 0(x2)        # 保存旧帧指针
    mv x8, x2           # 设置新帧指针
    
    # 变量声明和初始化
    li x5, 5            # x = 5
    sw x5, -4(x8)       # 存储到栈中
    li x5, 10           # y = 10
    sw x5, -8(x8)       # 存储到栈中
    
    # 表达式计算 z = x + y
    lw x5, -4(x8)       # 加载x
    lw x6, -8(x8)       # 加载y
    add x5, x5, x6      # x + y
    sw x5, -12(x8)      # 存储z
    
    # 返回语句
    lw x5, -12(x8)      # 加载z
    mv x10, x5          # 移动到返回值寄存器
    
    # 函数尾声
    mv x2, x8           # 恢复栈指针
    lw x8, 0(x2)        # 恢复帧指针
    addi x2, x2, 4      # 释放帧指针空间
    lw x1, 0(x2)        # 恢复返回地址
    addi x2, x2, 4      # 释放返回地址空间
    jalr x0, x1, 0      # 返回
```

### 5. 集成到编译流程

代码生成模块完美集成到现有的编译流程中：

1. **词法分析** → Token流
2. **语法分析** → AST
3. **语义分析** → 类型检查和符号表
4. **代码生成** → RISC-V汇编代码

输出的汇编文件可以使用RISC-V汇编器和链接器进一步处理，生成可执行文件。

### 6. 扩展性

代码结构设计良好，易于扩展：

- 可以轻松添加新的RISC-V指令
- 支持更复杂的优化策略
- 可以扩展支持浮点运算
- 易于添加调试信息生成

这个实现为ToyC编译器提供了完整的后端代码生成能力，生成的代码遵循RISC-V ABI标准，可以在RISC-V处理器上正确执行。
